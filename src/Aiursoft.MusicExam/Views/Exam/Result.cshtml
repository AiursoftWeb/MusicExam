@using Aiursoft.MusicExam.Entities
@using System.Text.Json
@inject Aiursoft.MusicExam.Services.FileStorage.StorageService Storage
@model Aiursoft.MusicExam.Models.ExamViewModels.ResultViewModel
@{
    ViewData["Title"] = Model.Title + " - " + Localizer["Result"];
}

<div class="container">
    <div class="card my-4 shadow-sm">
        <div class="card-body text-center py-5">
            <h1 class="card-title mb-4">@Model.Title</h1>

            <div class="mb-4">
                <div class="display-1 fw-bold @(Model.FinalScore >= 80 ? "text-success" : Model.FinalScore >= 60 ? "text-warning" : "text-danger")">
                    @Model.FinalScore
                </div>
                <div class="text-muted text-uppercase small">@Localizer["Final Score"]</div>
            </div>

            <h5 class="my-3 text-muted">
                @Localizer["Correct Answers"]: @Model.CorrectCount / @Model.TotalQuestions
            </h5>

            <div class="progress mb-4 w-50 mx-auto" style="height: 12px; border-radius: 6px;">
                <div class="progress-bar @(Model.FinalScore >= 80 ? "bg-success" : Model.FinalScore >= 60 ? "bg-warning" : "bg-danger")"
                     role="progressbar"
                     style="width: @(Model.FinalScore)%;"
                     aria-valuenow="@Model.FinalScore"
                     aria-valuemin="0"
                     aria-valuemax="100">
                </div>
            </div>

            <div class="mt-5">
                <a asp-controller="Dashboard" asp-action="Index"
                   class="btn btn-secondary me-2">@Localizer["Back to Dashboard"]</a>
                <a asp-controller="Manage" asp-action="ExamHistory" class="btn btn-info me-2">@Localizer["View History"]</a>
                <a asp-controller="Exam" asp-action="Take" asp-route-id="@Model.PaperId" class="btn btn-primary">@Localizer["Retake Exam"]</a>
            </div>
        </div>
    </div>

    @for (var i = 0; i < Model.Answers.Count; i++)
    {
        var answer = Model.Answers[i];
        var question = answer.Question;
        var questionAssets = !string.IsNullOrWhiteSpace(question.AssetPath) ? JsonSerializer.Deserialize<List<string>>(question.AssetPath) : new List<string>();
        var isCorrect = answer.IsCorrect;

        <div class="card mb-4 @(isCorrect ? "border-success" : "border-danger")">
            <div class="card-header @(isCorrect ? "text-success" : "text-danger")">
                <strong>@Localizer["Question"] @(i + 1)</strong>
                - @(isCorrect ? Localizer["Correct"] : Localizer["Incorrect"])
            </div>
            <div class="card-body">
                @* @Localizer["Correct"] *@
                @* @Localizer["Incorrect"] *@
                <h5 class="card-title">@question.Content</h5>

                @if (questionAssets != null)
                {
                    @foreach (var asset in questionAssets)
                    {
                        if (asset.EndsWith(".mp3", StringComparison.OrdinalIgnoreCase))
                        {
                            <div class="audio-player-wrapper d-inline-block mb-2 me-2" data-audio-src="@Storage.RelativePathToInternetUrl(asset, Context)"></div>
                        }
                        else if (asset.EndsWith(".jpg", StringComparison.OrdinalIgnoreCase) || asset.EndsWith(".png", StringComparison.OrdinalIgnoreCase) || asset.EndsWith(".jpeg", StringComparison.OrdinalIgnoreCase))
                        {
                            <img src="@Storage.RelativePathToInternetUrl(asset, Context)" class="img-fluid my-2"
                                 alt="Question asset"/>
                        }
                    }
                }

                @if (question.QuestionType == QuestionType.MultipleChoice)
                {
                    <div class="list-group mt-3">
                        @foreach (var option in question.Options.OrderBy(o => o.Id))
                        {
                            var isUserSelected = answer.UserSelectedOptionIds.Contains(option.Id);
                            var isCorrectOption = answer.CorrectOptionIds.Contains(option.Id);
                            var itemClass = "";

                            if (isCorrectOption)
                            {
                                itemClass = "list-group-item-success";
                            }
                            else if (isUserSelected) // Selected but wrong
                            {
                                itemClass = "list-group-item-danger";
                            }

                            <div class="list-group-item @itemClass">
                                <div class="d-flex w-100 justify-content-between">
                                    <span class="@(isUserSelected ? "fw-bold" : "")">
                                        @if (isUserSelected)
                                        {
                                            <i class="fas fa-check-circle me-2"></i>
                                        }

                                        @if (!option.Content.EndsWith(".mp3", StringComparison.OrdinalIgnoreCase) &&
                                             !option.Content.EndsWith(".jpg", StringComparison.OrdinalIgnoreCase) &&
                                             !option.Content.EndsWith(".png", StringComparison.OrdinalIgnoreCase))
                                        {
                                            @option.Content
                                        }
                                    </span>
                                    @if (isCorrectOption)
                                    {
                                        <span class="badge bg-success">@Localizer["Correct Answer"]</span>
                                    }
                                </div>

                                @if (option.Content.EndsWith(".mp3", StringComparison.OrdinalIgnoreCase))
                                {
                                    <div class="audio-player-wrapper d-inline-block align-middle mb-1" style="width: auto;" data-audio-src="@Storage.RelativePathToInternetUrl(option.Content, Context)"></div>
                                }
                                else if (option.Content.EndsWith(".jpg", StringComparison.OrdinalIgnoreCase) || option.Content.EndsWith(".png", StringComparison.OrdinalIgnoreCase) || option.Content.EndsWith(".jpeg", StringComparison.OrdinalIgnoreCase))
                                {
                                    <img src="@Storage.RelativePathToInternetUrl(option.Content, Context)" class="img-fluid my-2"
                                         style="max-height: 100px;" alt="Option asset"/>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="alert alert-info alert-outline-coloured mt-3" role="alert">
                        <div class="alert-icon">
                            <i class="fas fa-fw fa-info-circle"></i>
                        </div>
                        <div class="alert-message">
                            @Localizer["No detailed breakdown for this question type."]
                        </div>
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(question.Explanation))
                {
                    <div class="alert alert-info alert-outline-coloured alert-dismissible" role="alert">
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        <div class="alert-icon">
                            <i class="far fa-fw fa-lightbulb"></i>
                        </div>
                        <div class="alert-message">
                            <strong>@Localizer["Explanation"]:</strong>
                            @question.Explanation
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

@* ReSharper disable once Razor.SectionNotResolved *@

@section Scripts {
    <script src="~/scripts/audioPlayer.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Initialize Custom Audio Players
            document.querySelectorAll('.audio-player-wrapper').forEach(wrapper => {
                const src = wrapper.getAttribute('data-audio-src');
                new MusicExamAudioPlayer(wrapper, src);
            });
        });
    </script>
}
