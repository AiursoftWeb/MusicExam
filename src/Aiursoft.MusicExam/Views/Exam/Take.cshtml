@using System.Text.Json
@using Aiursoft.MusicExam.Entities
@inject Aiursoft.MusicExam.Services.FileStorage.StorageService Storage
@model Aiursoft.MusicExam.Models.ExamViewModels.TakeViewModel
@{
    ViewData["Title"] = Model.Paper.Title;
    var orderedQuestions = Model.Paper.Questions.OrderBy(q => q.Order).ToList();
}

<div class="container">
    <h1 class="my-4">@Model.Paper.Title</h1>
    @if (!string.IsNullOrEmpty(Model.Paper.Category))
    {
            <p class="text-muted mb-2">@Localizer["Category:"] @Model.Paper.Category</p>
    }
    <div class="progress mb-4" style="height: 25px;">
        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%; transition: width 0.5s ease;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    <hr />

    <form method="post" id="exam-form">
        @for (var i = 0; i < orderedQuestions.Count; i++)
        {
            var question = orderedQuestions[i];
            var questionAssets = !string.IsNullOrWhiteSpace(question.AssetPath) ? JsonSerializer.Deserialize<List<string>>(question.AssetPath) : new List<string>();

                <div class="question-panel" id="question-@i" style="display: @(i == 0 ? "block" : "none");">
                    <h4>(@(i + 1)/@orderedQuestions.Count) @question.Content</h4>

                @if (questionAssets != null)
                {
                    @foreach (var asset in questionAssets)
                    {
                        if (asset.EndsWith(".mp3", StringComparison.OrdinalIgnoreCase))
                        {
                                        <audio controls class="my-2">
                                            <source src="@Storage.RelativePathToInternetUrl(asset)" type="audio/mpeg">
                                            Your browser does not support the audio element.
                                        </audio>
                        }
                        else if (asset.EndsWith(".jpg", StringComparison.OrdinalIgnoreCase) || asset.EndsWith(".png", StringComparison.OrdinalIgnoreCase))
                        {
                                        <img src="@Storage.RelativePathToInternetUrl(asset)" class="img-fluid my-2" alt="Question asset" />
                        }
                    }
                }

                @switch (question.QuestionType)
                {
                    case QuestionType.MultipleChoice:
                        var correctAnswersCount = question.Options.Count(o => o.IsCorrect);
                                    <div class="list-group mt-3" id="options-group-@i">
                            @foreach (var option in question.Options.OrderBy(o => o.Id))
                            {
                                                <label class="list-group-item option-label" id="label-@option.Id">
                                                    <input class="form-check-input me-2"
                                                           type="@(correctAnswersCount > 1 ? "checkbox" : "radio")"
                                                           name="question-@question.Id"
                                                           value="@option.Id"
                                                           data-is-correct="@option.IsCorrect.ToString().ToLower()">

                                    @if (option.Content.EndsWith(".mp3", StringComparison.OrdinalIgnoreCase))
                                    {
                                                            <audio controls class="my-2 d-inline-block align-middle" style="max-height: 50px;">
                                                                <source src="@Storage.RelativePathToInternetUrl(option.Content)" type="audio/mpeg">
                                                            </audio>
                                    }
                                    else if (option.Content.EndsWith(".jpg", StringComparison.OrdinalIgnoreCase) || option.Content.EndsWith(".png", StringComparison.OrdinalIgnoreCase))
                                    {
                                                            <img src="@Storage.RelativePathToInternetUrl(option.Content)" class="img-fluid my-2" style="max-height: 100px;" alt="Option asset" />
                                    }
                                    else
                                    {
                                        @option.Content
                                    }
                                                </label>
                            }
                                    </div>
                                    <div class="feedback-area mt-2" id="feedback-@i" style="display:none;"></div>
                        if (correctAnswersCount > 1)
                        {
                                            <small class="form-text text-muted">@Localizer["This is a multiple choice question."]</small>
                        }
                        break;

                    case QuestionType.SightSinging:
                                    <div class="alert alert-info mt-3">
                            @Localizer["This is a sight-singing question. Please review the sheet music and sing aloud."]
                                    </div>
                        break;
                }


                @if (!string.IsNullOrWhiteSpace(question.Explanation))
                {
                            <div id="explanation-@i" style="display: none;" class="alert alert-secondary mt-2">
                                <strong>@Localizer["Explanation"]:</strong>
                                <p>@question.Explanation</p>
                            </div>
                }
                    <hr />
                </div>
        }

        <div class="d-flex justify-content-between my-4">
            <button type="button" id="prev-btn" class="btn btn-secondary" disabled>@Localizer["Previous"]</button>
            <button type="button" id="check-btn" class="btn btn-info">@Localizer["Check Answer"]</button>
            <button type="button" id="next-btn" class="btn btn-primary" style="display: none;">@Localizer["Next"]</button>
            <button type="submit" id="submit-btn" class="btn btn-success" style="display: none;">@Localizer["Submit Exam"]</button>
        </div>
    </form>
</div>

@* ReSharper disable once Razor.SectionNotResolved *@
@section Scripts {
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                let currentQuestionIndex = 0;
                const questions = document.querySelectorAll(".question-panel");
                const prevBtn = document.getElementById("prev-btn");
                const nextBtn = document.getElementById("next-btn");
                const checkBtn = document.getElementById("check-btn");
                const submitBtn = document.getElementById("submit-btn");

                // Add mutual exclusion for audio
                const allAudios = document.querySelectorAll('audio');
                allAudios.forEach(playAudio => {
                    playAudio.addEventListener('play', function () {
                        allAudios.forEach(otherAudio => {
                            if (otherAudio !== playAudio) {
                                otherAudio.pause();
                            }
                        });
                    });
                });

                function showQuestion(index) {
                    // Pause all audio elements
                    document.querySelectorAll('audio').forEach(audio => {
                        audio.pause();
                        audio.currentTime = 0;
                    });

                    questions.forEach((q, i) => {
                        q.style.display = i === index ? "block" : "none";
                    });

                    prevBtn.disabled = index === 0;

                    // Update progress bar
                    if (questions.length > 0) {
                        const progress = ((index + 1) / questions.length) * 100;
                        const progressBar = document.getElementById("progress-bar");
                        progressBar.style.width = progress + "%";
                        progressBar.setAttribute("aria-valuenow", progress);
                        progressBar.innerText = Math.round(progress) + "%";
                    }

                    // Reset buttons state for new question
                    checkBtn.style.display = "block";
                    nextBtn.style.display = "none";
                    submitBtn.style.display = "none";

                    // If already checked (could be implemented if we want to support going back and seeing result),
                    // but for now let's reset or just keep it simple.
                    // Since verification requires "Check Answer", and we might move back/forth,
                    // we should probably check if feedback is already visible.
                    const feedback = document.getElementById(`feedback-${index}`);
                    if (feedback && feedback.style.display === "block") {
                         checkBtn.style.display = "none";
                         if (index === questions.length - 1) {
                             submitBtn.style.display = "block";
                         } else {
                             nextBtn.style.display = "block";
                         }
                    }
                }

                checkBtn.addEventListener("click", function() {
                    const currentQuestion = questions[currentQuestionIndex];
                    const inputs = currentQuestion.querySelectorAll("input");

                    // If no inputs (e.g. sight singing), just show correct/info
                    if (inputs.length === 0) {
                         // Auto pass
                    } else {
                        let answered = false;
                        inputs.forEach(input => {
                            if (input.checked) answered = true;
                        });

                        if (!answered) {
                            alert("@Localizer["Please select an answer first."]");
                            return;
                        }
                    }

                    // Show feedback
                    let allCorrect = true;
                    inputs.forEach(input => {
                        const isCorrect = input.getAttribute("data-is-correct") === "true";
                        const label = document.getElementById(`label-${input.value}`);

                        if (isCorrect) {
                            label.classList.add("list-group-item-success");
                            label.classList.add("fw-bold");
                        } else if (input.checked) {
                            label.classList.add("list-group-item-danger");
                            allCorrect = false;
                        } else {
                             // If it's not checked and not correct, do nothing
                        }

                        // We DO NOT disable inputs here, because disabled inputs are not submitted.
                        // Instead we disable interaction via CSS/event prevention if needed, or simply let it be.
                        // To prevent changing answers after checking, we can disable them but must re-enable on submit.
                        // Let's use the 'onclick return false' trick or just re-enable on submit.
                        // Re-enabling on submit is safer.
                        input.disabled = true;
                    });

                    const feedback = document.getElementById(`feedback-${currentQuestionIndex}`);
                    if(feedback) {
                        feedback.style.display = "block";
                        if(allCorrect) {
                            feedback.innerHTML = '<div class="alert alert-success">@Localizer["Correct!"]</div>';
                        } else {
                            feedback.innerHTML = '<div class="alert alert-danger">@Localizer["Incorrect! Please check the correct answer highlighted above."]</div>';
                        }
                    }

                    const explanation = document.getElementById(`explanation-${currentQuestionIndex}`);
                    if (explanation) {
                        explanation.style.display = "block";
                    }

                    checkBtn.style.display = "none";
                    if (currentQuestionIndex === questions.length - 1) {
                        submitBtn.style.display = "block";
                    } else {
                        nextBtn.style.display = "block";
                    }
                });

                // Re-enable inputs before submit
                document.getElementById("exam-form").addEventListener("submit", function() {
                    const inputs = document.querySelectorAll("input");
                    inputs.forEach(input => {
                        input.disabled = false;
                    });
                });

                prevBtn.addEventListener("click", function () {
                    if (currentQuestionIndex > 0) {
                        currentQuestionIndex--;
                        showQuestion(currentQuestionIndex);
                    }
                });

                nextBtn.addEventListener("click", function () {
                    if (currentQuestionIndex < questions.length - 1) {
                        currentQuestionIndex++;
                        showQuestion(currentQuestionIndex);
                    }
                });

                showQuestion(0);
            });
        </script>
}
