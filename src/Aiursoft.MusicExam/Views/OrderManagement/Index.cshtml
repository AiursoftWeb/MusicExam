@model Aiursoft.MusicExam.Models.OrderManagementViewModels.IndexViewModel

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<div class="row mb-3">
    <div class="col">
        <h3>@Localizer["Manage Display Order"]</h3>
        <p class="text-muted">@Localizer["Drag and drop items to reorder them. Click Save when finished."]</p>
    </div>
    <div class="col-auto">
        <button id="saveOrderBtn" class="btn btn-primary">
            <i class="bi bi-save"></i> @Localizer["Save Order"]
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div id="schoolList" class="sortable-container">
            @foreach (var school in Model.Schools)
            {
                <div class="sortable-item school-item card mb-3" data-id="@school.Id">
                    <div class="card-header bg-primary text-white d-flex align-items-center">
                        <i class="drag-handle bi bi-grip-vertical me-2" style="cursor: grab;"></i>
                        <strong>@school.Name</strong>
                        <span class="badge bg-light text-dark ms-auto">School</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="level-list sortable-container" data-school-id="@school.Id">
                            @foreach (var level in school.Levels)
                            {
                                var levelCollapseId = $"collapse-level-{school.Id}-{Math.Abs(level.Name.GetHashCode())}";
                                <div class="sortable-item level-item accordion-item" data-level="@level.Name">
                                    <h2 class="accordion-header d-flex align-items-center" id="heading-@levelCollapseId">
                                        <i class="drag-handle bi bi-grip-vertical ms-2 me-1" style="cursor: grab; font-size: 1.2rem;"></i>
                                        <button class="accordion-button collapsed flex-grow-1" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#@levelCollapseId"
                                                aria-expanded="false"
                                                aria-controls="@levelCollapseId">
                                            <i class="bi bi-layers me-2"></i>
                                            @Localizer["Level"]: @level.Name
                                            <span class="badge bg-info text-dark ms-2">@level.Categories.Sum(c => c.Papers.Count) @Localizer["Papers"]</span>
                                        </button>
                                    </h2>
                                    <div id="@levelCollapseId" class="accordion-collapse collapse"
                                         aria-labelledby="heading-@levelCollapseId">
                                        <div class="accordion-body p-2">
                                            <div class="category-list sortable-container" data-school-id="@school.Id" data-level="@level.Name">
                                                @foreach (var category in level.Categories)
                                                {
                                                    var catCollapseId = $"collapse-cat-{school.Id}-{Math.Abs(level.Name.GetHashCode())}-{Math.Abs(category.Name.GetHashCode())}";
                                                    <div class="sortable-item category-item accordion-item" data-category="@category.Name">
                                                        <h2 class="accordion-header d-flex align-items-center" id="heading-@catCollapseId">
                                                            <i class="drag-handle bi bi-grip-vertical ms-2 me-1" style="cursor: grab; font-size: 1.1rem;"></i>
                                                            <button class="accordion-button collapsed flex-grow-1" type="button"
                                                                    data-bs-toggle="collapse"
                                                                    data-bs-target="#@catCollapseId"
                                                                    aria-expanded="false"
                                                                    aria-controls="@catCollapseId">
                                                                <i class="bi bi-folder me-2"></i>
                                                                @category.Name
                                                                <span class="badge bg-secondary ms-2">@category.Papers.Count @Localizer["Papers"]</span>
                                                            </button>
                                                        </h2>
                                                        <div id="@catCollapseId" class="accordion-collapse collapse"
                                                             aria-labelledby="heading-@catCollapseId">
                                                            <div class="accordion-body p-2">
                                                                <div class="paper-list sortable-container"
                                                                     data-school-id="@school.Id"
                                                                     data-level="@level.Name"
                                                                     data-category="@category.Name">
                                                                    @foreach (var paper in category.Papers)
                                                                    {
                                                                        <div class="sortable-item paper-item list-group-item d-flex align-items-center mb-1"
                                                                             data-id="@paper.Id">
                                                                            <i class="drag-handle bi bi-grip-vertical me-2" style="cursor: grab;"></i>
                                                                            <span>@paper.Title</span>
                                                                        </div>
                                                                    }
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    const sortableOptions = {
        animation: 150,
        handle: '> .accordion-header > .drag-handle',
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag'
    };

    // Initialize SortableJS for Schools
    const schoolList = document.getElementById('schoolList');
    if (schoolList) {
        Sortable.create(schoolList, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag'
        });
    }

    // Initialize SortableJS for Level lists
    document.querySelectorAll('.level-list').forEach(list => {
        Sortable.create(list, sortableOptions);
    });

    // Initialize SortableJS for Category lists
    document.querySelectorAll('.category-list').forEach(list => {
        Sortable.create(list, sortableOptions);
    });

    // Initialize SortableJS for Paper lists
    document.querySelectorAll('.paper-list').forEach(paperList => {
        Sortable.create(paperList, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag'
        });
    });

    // Save order button
    // Traverses the full DOM hierarchy to compute paper DisplayOrder values:
    // School → Level → Category → Paper
    // Since Level and Category are string fields on ExamPaper (not separate entities),
    // reordering them is reflected by adjusting the DisplayOrder of all papers within.
    document.getElementById('saveOrderBtn').addEventListener('click', async () => {
        const saveBtn = document.getElementById('saveOrderBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

        try {
            // 1. Save school order
            const schoolItems = [...schoolList.querySelectorAll(':scope > .school-item')];
            const schoolOrder = schoolItems.map((item, index) => ({
                id: parseInt(item.dataset.id),
                displayOrder: index
            }));

            await fetch('/OrderManagement/UpdateSchoolOrder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: schoolOrder })
            });

            // 2. Compute paper order from full hierarchy
            // Walk School → Level → Category → Paper in DOM order
            const allPaperOrders = [];
            let globalOrder = 0;

            schoolItems.forEach(schoolEl => {
                const levelItems = schoolEl.querySelectorAll(':scope > .card-body > .level-list > .level-item');
                levelItems.forEach(levelEl => {
                    const categoryItems = levelEl.querySelectorAll(':scope > .accordion-collapse > .accordion-body > .category-list > .category-item');
                    categoryItems.forEach(categoryEl => {
                        const paperItems = categoryEl.querySelectorAll(':scope > .accordion-collapse > .accordion-body > .paper-list > .paper-item');
                        paperItems.forEach(paperEl => {
                            allPaperOrders.push({
                                id: parseInt(paperEl.dataset.id),
                                displayOrder: globalOrder++
                            });
                        });
                    });
                });
            });

            if (allPaperOrders.length > 0) {
                await fetch('/OrderManagement/UpdatePaperOrder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: allPaperOrders })
                });
            }

            alert('@Localizer["Order saved successfully!"]');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-save"></i> @Localizer["Save Order"]';
        } catch (error) {
            console.error('Error saving order:', error);
            alert('@Localizer["Failed to save order. Please try again."]');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-save"></i> @Localizer["Save Order"]';
        }
    });
</script>

<style>
    .sortable-ghost {
        opacity: 0.4;
        background: #f8f9fa;
    }
    
    .sortable-chosen {
        background: #e9ecef;
    }
    
    .sortable-drag {
        opacity: 1;
    }
    
    .drag-handle:active {
        cursor: grabbing !important;
    }
    
    .school-item {
        transition: all 0.2s ease;
    }
    
    .school-item:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .paper-item {
        transition: all 0.15s ease;
        border-radius: 0.25rem;
    }
    
    .paper-item:hover {
        background: #f8f9fa;
    }
</style>
