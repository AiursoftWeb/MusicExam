@model Aiursoft.MusicExam.Models.OrderManagementViewModels.IndexViewModel

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<div class="row mb-3">
    <div class="col">
        <h3>@Localizer["Manage Display Order"]</h3>
        <p class="text-muted">@Localizer["Drag and drop items to reorder them. Click Save when finished."]</p>
    </div>
    <div class="col-auto">
        <button id="saveOrderBtn" class="btn btn-primary">
            <i class="bi bi-save"></i> @Localizer["Save Order"]
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div id="schoolList" class="sortable-container">
            @foreach (var school in Model.Schools)
            {
                <div class="sortable-item school-item card mb-3" data-id="@school.Id">
                    <div class="card-header bg-primary text-white d-flex align-items-center">
                        <i class="drag-handle bi bi-grip-vertical me-2" style="cursor: grab;"></i>
                        <strong>@school.Name</strong>
                        <span class="badge bg-light text-dark ms-auto">School</span>
                    </div>
                    <div class="card-body">
                        @foreach (var level in school.Levels)
                        {
                            <div class="level-group mb-3">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge bg-info text-dark me-2">Level:</span>
                                    <strong>@level.Name</strong>
                                </div>
                                
                                @foreach (var category in level.Categories)
                                {
                                    <div class="category-group ms-3 mb-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge bg-secondary me-2">Category:</span>
                                            <strong>@category.Name</strong>
                                        </div>
                                        
                                        <div class="paper-list sortable-container ms-3" 
                                             data-school-id="@school.Id"
                                             data-level="@level.Name"
                                             data-category="@category.Name">
                                            @foreach (var paper in category.Papers)
                                            {
                                                <div class="sortable-item paper-item list-group-item d-flex align-items-center mb-1" 
                                                     data-id="@paper.Id">
                                                    <i class="drag-handle bi bi-grip-vertical me-2" style="cursor: grab;"></i>
                                                    <span>@paper.Title</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    // Initialize SortableJS for Schools
    const schoolList = document.getElementById('schoolList');
    if (schoolList) {
        Sortable.create(schoolList, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag'
        });
    }

    // Initialize SortableJS for all Paper lists
    document.querySelectorAll('.paper-list').forEach(paperList => {
        Sortable.create(paperList, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag'
        });
    });

    // Get anti-forgery token
    function getAntiForgeryToken() {
        return document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
    }

    // Save order button
    document.getElementById('saveOrderBtn').addEventListener('click', async () => {
        const saveBtn = document.getElementById('saveOrderBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
        
        try {
            // Collect school order
            const schoolItems = [...schoolList.querySelectorAll('.school-item')];
            const schoolOrder = schoolItems.map((item, index) => ({
                id: parseInt(item.dataset.id),
                displayOrder: index
            }));
            
            // Save school order
            await fetch('/OrderManagement/UpdateSchoolOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ items: schoolOrder })
            });
            
            // Collect and save paper orders
            const paperLists = document.querySelectorAll('.paper-list');
            for (const paperList of paperLists) {
                const paperItems = [...paperList.querySelectorAll('.paper-item')];
                const paperOrder = paperItems.map((item, index) => ({
                    id: parseInt(item.dataset.id),
                    displayOrder: index
                }));
                
                if (paperOrder.length > 0) {
                    await fetch('/OrderManagement/UpdatePaperOrder', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ items: paperOrder })
                    });
                }
            }
            
            // Show success message
            alert('@Localizer["Order saved successfully!"]');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-save"></i> @Localizer["Save Order"]';
        } catch (error) {
            console.error('Error saving order:', error);
            alert('@Localizer["Failed to save order. Please try again."]');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-save"></i> @Localizer["Save Order"]';
        }
    });
</script>

<style>
    .sortable-ghost {
        opacity: 0.4;
        background: #f8f9fa;
    }
    
    .sortable-chosen {
        background: #e9ecef;
    }
    
    .sortable-drag {
        opacity: 1;
    }
    
    .drag-handle:active {
        cursor: grabbing !important;
    }
    
    .school-item {
        transition: all 0.2s ease;
    }
    
    .school-item:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .paper-item {
        transition: all 0.15s ease;
        border-radius: 0.25rem;
    }
    
    .paper-item:hover {
        background: #f8f9fa;
    }
</style>
